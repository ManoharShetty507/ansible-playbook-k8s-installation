tasks:
  - name: Apply kube-proxy ConfigMap changes
    shell: |
      kubectl get configmap kube-proxy -n kube-system -o yaml | \
      sed -e "s/strictARP: false/strictARP: true/" | \
      kubectl apply -f - -n kube-system
    environment:
      KUBECONFIG: "{{ kubeconfig_path }}"  # Ensure this is correctly set

  - name: Apply MetalLB manifests
    command: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml
    environment:
      KUBECONFIG: "{{ kubeconfig_path }}"  # Ensure this is correctly set

  - name: Create IPAddressPool YAML from template
    template:
      src: ipaddresspool.yaml.j2
      dest: /tmp/ipaddresspool.yaml

  - name: Apply IPAddressPool configuration
    command: kubectl apply -f /tmp/ipaddresspool.yaml
    environment:
      KUBECONFIG: "{{ kubeconfig_path }}"  # Ensure this is correctly set

  - name: Create L2Advertisement YAML from template
    template:
      src: l2advertisement.yaml.j2
      dest: /tmp/l2advertisement.yaml

  - name: Apply L2Advertisement configuration
    command: kubectl apply -f /tmp/l2advertisement.yaml
    environment:
      KUBECONFIG: "{{ kubeconfig_path }}"  # Ensure this is correctly set
